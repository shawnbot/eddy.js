(function(e){var t={parent:"#timeline",smooth:"monotone",autoIncrement:!1,historyMin:NaN,filterMin:NaN,nice:!1};eddy.timeline=function(e){function b(){var e=n.x,t=n.y,o=e-(r[1]+r[3]),a=t-(r[0]+r[2]);i.range([r[3],e-r[1]]),s.range([t-r[2],r[0]]),u.setSize(e,t),w(),N()}function w(e){if(d)x(a,d.history,e),E(e);else{var t=S();x(a,t,e),x(f,t,e)}}function E(e){if(d&&h){var n=typeof h=="object"?h:"filtersById"in d?d.filtersById[h]:null;n&&n.history?(x(f,n.history,e),t.dispatch("filter",n)):(console.warn("no such filter found:",h),t.dispatch("filter",null))}else{var r=S();x(f,r,e)}}function S(){var e=i.domain(),t=d3.range(e[0],e[1]+m,m);return t.map(function(e){return{time:e,count:0,total:0}})}function x(t,n,r){var o=s.copy(),u=t.data("ymin");isNaN(u)||(o.domain([u,o.domain()[1]]),console.log("domain:",u,o.domain()));var a=d3.svg.area().x(function(e){return i(e.time)}).y0(s.range()[0]).y1(function(e){return o(e.count)});e.smooth&&a.interpolate(e.smooth);var f=a(n);if(r){var l={ms:300,easing:"linear",callback:null};typeof r=="object"&&eddy.util.merge(l,r),t.animate({path:f},l.ms,l.easing,l.callback)}else t.attr("path",f)}function T(){if(c&&d){N(),l.style("visibility","visible"),l.select(".time").text(t.formatTime(c));var e=t.timetoindex(c),n=d.history[e],r=n?n.count:0,i=n?n.total:0;l.select(".total").text(t.formatCount(i)),l.select(".marker").style("top",~~s(r)+"px"),n.usage?l.select(".since").style("display",null).select(".since-time").text(t.formatTime(n.usage.start)):l.select(".since").style("display","none")}else l.style("visibility","hidden")}function N(){var e=t.timetox(c);l.style("left",Math.round(e||0)+"px")}function C(e){var n=t.xtotime(e);t.selectTime(n,{interactive:!0})}function L(){var e=d3.mouse(this),t=e[0];C(t),o.on("mousemove",function(){e=d3.mouse(this),t=e[0],C(t)}),d3.select("body").on("mouseup",A),k=!0,d3.event.preventDefault()}function A(){o.on("mousemove",null),d3.select("body").on("mouseup",null),k=!1}function O(e){var n=0;switch(e.keyCode){case 37:n=-m;break;case 39:n=+m}if(n!=0){var r=e.shiftKey?10:1;t.stepTime(n*r)}}e=eddy.util.merge({},eddy.timeline.defaults,e);var t=this instanceof eddy.timeline?this:{};eddy.dispatch(t),t.options=e;var n={x:400,y:80},r=[0,0,0,0],i=d3.scale.linear().clamp(!0),s=d3.scale.linear().clamp(!0),o,u,a,f,l,c,h,p,d,v=!1,m=60,g=d3.time.format("%I:%M%p");t.formatTime=function(e){var t=new Date(e*1e3);return g(t).toLowerCase().replace(/^0+/g,"").replace(":00","")},t.formatCount=d3.format(",0"),t.attach=function(n){o=d3.select(n).on("mousedown",L),u=new Raphael(o.node()),a=u.path().data("ymin",e.historyMin).attr(e.historyStyle||{fill:"#000",stroke:null}),f=u.path().data("ymin",e.filterMin).attr(e.filterStyle||{fill:"#f0f",stroke:null}),l=o.append("div").attr("class","cursor").style("position","absolute").style("top","0px").style("height","100%"),l.append("div").attr("class","line").style("visibility","hidden"),l.append("div").attr("class","marker");var r=l.append("div").attr("class","text");return r.append("span").attr("class","total"),r.append("span").attr("class","total-label").text(" tweets"),r.append("span").attr("class","since").text(" from ").append("span").attr("class","since-time"),r.append("span").attr("class","time-label").text(" to "),r.append("span").attr("class","time"),t.historyPath=a,t.filterPath=f,t.cursor=l,b(),t},t.detach=function(){u.remove()},t.setSize=function(e,r){return n={x:e,y:r},b(),t},t.autoSize=function(){var e=o.property("offsetWidth"),r=o.property("offsetHeight");return n={x:e,y:r},b(),t},t.padding=function(e){if(arguments.length){if(e instanceof Array)switch(e.length){case 1:r=[e[0],e[0],e[0],e[0]];break;case 2:r=[e[0],e[1],e[0],e[1]];break;case 3:r=[e[0],e[1],e[2],e[1]];break;default:r=e}else typeof e=="object"?r=[e.top,e.right,e.bottom,e.left]:isNaN(e)||(r=[e,e,e,e]);return b(),t}return r.slice()},t.update=function(n,r){p=d,d=n,t.currentData=d;var o=d.history;m=d.time.period;var u=i.domain(),l=c===u[1],h=o[0],g=o[o.length-1];i.domain([h.time,g.time]);var y=o.map(function(e){return e.count});y.sort();var b=d3.extent(y);s.domain(b),e.nice&&s.nice();if(!v){var E=S();x(a,E,!1),x(f,E,!1)}return w(r),v=!0,!c||l?t.selectTime(i.domain()[1],{auto:!0}):T(),t},t.selectTime=function(n,r){if(c!==n){r||(r={});var s=c;r.offset=s?n-c:NaN,t.selectedTime=c=n,T();var o=c===i.domain()[1];r.last=o,r.silent||t.dispatch("select",n,r);if(o&&e.autoIncrement){var u=d.history,a=u.length-1,f=u[a].total,l=u[a-1].total;t.startIncrementing(l,f,m*1e3)}else t.stopIncrementing()}return t},t.selectFilter=function(e,n){return h=e,E(n),t};var y;t.startIncrementing=function(e,n,r){clearInterval(y),n<e&&(e=0);var i=e,s=n-e,o=s/r,u=10,a=o*u,f=l.select(".total").text(t.formatCount(i));return y=setInterval(function(){i+=a,f.text(t.formatCount(~~i))},u),t},t.stopIncrementing=function(){return clearInterval(y),t},t.xtotime=function(e){var t=i.invert(e);return~~(t/m)*m},t.timetox=function(e){return i(e)},t.timetoindex=function(e){var t=i.copy().rangeRound([0,d.history.length-1]);return t(e)},t.xtoindex=function(e){var t=d3.scale.linear().domain(i.range()).rangeRound([0,d.history.length-1]);return t(e)},t.stepTime=function(e){if(c){var n=i.domain(),r=c+e;return e<0?r=Math.max(r,n[0]):r=Math.min(r,n[1]),t.selectTime(r,{offset:e})}return!1},t.addKeyHandlers=function(e){return e||(e=window),e.addEventListener("keydown",O),t},t.removeKeyHandlers=function(e){return e||(e=window),e.removeEventListener("keydown",O),t};var k=!1;return t.attach(e.parent)},eddy.timeline.defaults=t})(this);