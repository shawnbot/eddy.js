(function(e){var t={parent:"#timeline",smooth:"monotone",incrementLastCount:!1,historyMin:null,filterMin:null,nice:!1};eddy.timeline=function(e){function b(){var e=n.x,t=n.y,o=e-(r[1]+r[3]),a=t-(r[0]+r[2]);i.range([r[3],e-r[1]]),s.range([t-r[2],r[0]]),u.setSize(e,t),w(),N()}function w(e){if(v)x(a,v.history,e),E(e);else{var t=S();x(a,t,e),x(f,t,e)}}function E(e){if(v&&h){var t=typeof h=="object"?h:"filtersById"in v?v.filtersById[h]:null;t&&t.history?(console.log("filter history:",t.history.map(function(e){return e.count})),x(f,t.history,e)):console.warn("no such filter found:",h)}else{var n=S();x(f,n,e)}}function S(){var e=i.domain(),t=d3.range(e[0],e[1],m);return t.map(function(e){return{time:e,count:0,total:0}})}function x(t,n,r){var o=s.copy(),u=t.data("ymin");isNaN(u)||o.domain([u,o.domain()[1]]);var a=d3.svg.area().x(function(e){return i(e.time)}).y0(s.range()[0]).y1(function(e){return o(e.count)});e.smooth&&a.interpolate(e.smooth);var f=a(n);if(r){var l={ms:300,easing:"linear",callback:null};typeof r=="object"&&eddy.util.merge(l,r),t.animate({path:f},l.ms,l.easing,l.callback)}else t.attr("path",f)}function T(){if(c&&v){N(),l.style("visibility","visible"),l.select(".time").text(t.formatTime(c));var e=t.timetoindex(c),n=v.history[e],r=n?n.count:0,i=n?n.total||0:0;l.select(".total").text(t.formatCount(i)),l.select(".marker").style("top",~~s(r)+"px")}else l.style("visibility","hidden")}function N(){var e=t.timetox(c);l.style("left",Math.round(e)+"px")}function C(e){var n=t.xtotime(e);t.selectTime(n,!0)}function L(){var e=d3.mouse(this),t=e[0];C(t),o.on("mousemove",function(){e=d3.mouse(this),t=e[0],C(t)}),d3.select("body").on("mouseup",A),k=!0,d3.event.preventDefault()}function A(){o.on("mousemove",null),d3.select("body").on("mouseup",null),k=!1}e=eddy.util.merge({},eddy.timeline.defaults,e);var t=this instanceof eddy.timeline?this:{};eddy.dispatch(t),t.options=e;var n={x:400,y:80},r=[0,0,0,0],i=d3.scale.linear().clamp(!0),s=d3.scale.linear().clamp(!0),o,u,a,f,l,c,h,p=!1,d,v,m=60,g=d3.time.format("%I:%M%p");t.formatTime=function(e){var t=new Date(e*1e3);return g(t).toLowerCase().replace(/^0+/g,"")},t.formatCount=d3.format(",0"),t.attach=function(n){o=d3.select(n).on("mousedown",L),u=new Raphael(o.node()),a=u.path().data("ymin",e.historyMin).attr(e.historyStyle||{fill:"#000",stroke:null}),f=u.path().data("ymin",e.filterMin).attr(e.filterStyle||{fill:"#f0f",stroke:null}),l=o.append("div").attr("class","cursor").style("position","absolute").style("top","0px").style("height","100%"),l.append("div").attr("class","line").style("visibility","hidden"),l.append("div").attr("class","marker");var r=l.append("div").attr("class","text");return r.append("span").attr("class","total"),r.append("span").attr("class","total-label").text(" tweets as of "),r.append("span").attr("class","time"),t.historyPath=a,t.filterPath=f,t.cursor=l,b(),t},t.detach=function(){u.remove()},t.setSize=function(e,r){return n={x:e,y:r},b(),t},t.autoSize=function(){var e=o.property("offsetWidth"),r=o.property("offsetHeight");return n={x:e,y:r},b(),t},t.padding=function(e){if(arguments.length){if(e instanceof Array)switch(e.length){case 1:r=[e[0],e[0],e[0],e[0]];break;case 2:r=[e[0],e[1],e[0],e[1]];break;case 3:r=[e[0],e[1],e[2],e[1]];break;default:r=e}else typeof e=="object"?r=[e.top,e.right,e.bottom,e.left]:isNaN(e)||(r=[e,e,e,e]);return b(),t}return r.slice()},t.update=function(n,r){d=v,v=n,t.currentData=v;var o=v.history;m=v.time.period;var u=i.domain(),l=c===u[1],h=o[0],g=o[o.length-1];i.domain([h.time,g.time]);var y=o.map(function(e){return e.count});y.sort();var b=d3.extent(y);s.domain(b),e.nice&&s.nice();if(!p){var E=S();x(a,E),x(f,E)}return w(r),p=!0,(!c||l)&&t.selectTime(i.domain()[1]),t},t.selectTime=function(n){if(c!==n){c=n,T();var r=c===i.domain()[1];t.dispatch("select",n,r);if(r&&e.autoIncrement){var s=v.history,o=s.length-1,u=s[o].total,a=s[o-1].total;t.startIncrementing(a,u,m*1e3)}else t.stopIncrementing()}return t},t.selectFilter=function(e,n){return h=e,E(n),t};var y;t.startIncrementing=function(e,n,r){clearInterval(y);var i=e,s=n-e,o=s/r,u=10,a=o*u,f=l.select(".total").text(t.formatCount(i));return a>0?y=setInterval(function(){i+=a,f.text(t.formatCount(~~i))},u):console.warn("negative increment span:",[e,n],"->",s,"; not incrementing"),t},t.stopIncrementing=function(){return clearInterval(y),t},t.xtotime=function(e){var t=i.invert(e);return~~(t/m)*m},t.timetox=function(e){return i(e)},t.timetoindex=function(e){var t=i.copy().rangeRound([0,v.history.length-1]);return t(e)},t.xtoindex=function(e){var t=d3.scale.linear().domain(i.range()).rangeRound([0,v.history.length-1]);return t(e)};var k=!1;return t.attach(e.parent)},eddy.timeline.defaults=t})(this);